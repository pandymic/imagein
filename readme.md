This is an ambitious pet project. Javascript is a bit of a mess since it's mostly just a proof-of-concept. Inspired by a terrible project management system whose comment/discussion functionality doesn't support embedding images or media of any sort.

The purpose of this script is two-fold.

1. The *File Dropper* component allows users to drop-in hyperlinks to uploaded images when creating comments. 
2. The *File Replacer* component converts those hyperlinks to `<img>` tags when viewing the content in the future.

Currently all client-side functionality is handled using Bookmarklets, but this can be rolled into a browser extension if it proves useful.

## File Dropper

A universal file upload script. Supports Drag-and-drop as well as Copy-and-paste functionality. Images are automatically scaled and optimized to webp client-side before being uploaded to the server. Images are named with the md5 hash of their binary contents. This provides a convenient pattern to match against in the File Replacer function. It also provides a (slight) measure of protection against duplicate images.

The dropper opens a `<dialog>` modal over the page. After an image is successfully uploaded to the server its absolute URL is returned and dropped into the browser at the current cursor position. Either inserts at the caret or replaces the curren selection.

### Assumptions & Notes

* For privacy the github repo does not include any URL's or paths to the actual production environment. Instead, all of these values are stored server-side in a configuration file called `imagein.conf`. It's assumed that the file is a valid PHP script with a return statement on its last line. It lives in the folder `/etc` relative to the project directory (i.e. `../../etc` relative to the web root.)
* The base URL as well as the CSS string in the bookmarklet below are generated server-side for conveninence. See `index.php` in the web root.
* An example of this configuration file is as follows
<pre>
&lt;?php

return (object)[
  'baseUrl' => '<i>BASE_URL_TO_APP</i>',
  'cssString' => base64_encode( preg_replace( '/[\r\n]+/', '', preg_replace( '/^\s+/', '', file_get_contents( __DIR__ . '/../html/imagein/imagein.css' ) ) ) ),
  'testFile' => 'file/' . basename( array_pop( glob( __DIR__ . '/../html/imagein/file/*.webp' ) ), '.webp' ) . '.webp'
];
</pre>

### Bookmarklet

#### Script loader method.
<pre>
javascript:(function(a){const b = a.createElement( 'SCRIPT' ); b.src = '<i>[project-base-url]</i>/imagein.js?baseUrl=<i>[project-base-url]</i>&css=LnBhbmR5bWljLWltYWdlaW4geyAgcG9zaXRpb246IHJlbGF0aXZlOyAgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsgIGNvbG9yOiAjNjY2OyAgd2lkdGg6IDUxMnB4OyAgaGVpZ2h0OiA1MTJweDsgIGJvcmRlci1yYWRpdXM6NjBweDsgIHRyYW5zaXRpb246IG9wYWNpdHkgMzc1bXMgZWFzZS1vdXQsIHNjYWxlIDI1MG1zIGVhc2Utb3V0IDEyNW1zO30ucGFuZHltaWMtaW1hZ2Vpbjo6YmFja2Ryb3AgeyAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsgIG9wYWNpdHk6IDAuODU7fS5wYW5keW1pYy1pbWFnZWluOmJlZm9yZSB7ICBjb250ZW50OiAnJzsgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgIHRvcDogMTBweDsgIHJpZ2h0OiAxMHB4OyAgYm90dG9tOiAxMHB4OyAgbGVmdDogMTBweDsgIGJvcmRlcjogNXB4IGRhc2hlZCBjdXJyZW50Y29sb3I7ICBib3JkZXItcmFkaXVzOiA1MHB4fS5wYW5keW1pYy1pbWFnZWluOmFmdGVyIHsgIGNvbnRlbnQ6ICdEcmFnIGZpbGUgaGVyZS4nOyAgdGV4dC1hbGlnbjogY2VudGVyOyAgcG9zaXRpb246IGFic29sdXRlOyAgdG9wOiA1MCU7ICBsZWZ0OiA1MCU7ICBtYXgtd2lkdGg6IDc1dnc7ICB0cmFuc2xhdGU6IC01MCUgLTUwJTsgIGNvbG9yOiBjdXJyZW50Y29sb3I7ICBmb250LWZhbWlseTogbW9ub3NwYWNlOyAgZm9udC1zaXplOiA1dmh9LnBhbmR5bWljLWltYWdlaW4ucGFuZHltaWMtaW1hZ2Vpbi1kcmFnOmFmdGVyIHsgIGNvbnRlbnQ6ICdEcm9wIGZpbGUhJ30ucGFuZHltaWMtaW1hZ2Vpbi5wYW5keW1pYy1pbWFnZWluLWVycm9yIHsgIGNvbG9yOiAjYzMwfS5wYW5keW1pYy1pbWFnZWluLnBhbmR5bWljLWltYWdlaW4tZHJhZyB7ICBjb2xvcjogIzA2Y30ucGFuZHltaWMtaW1hZ2Vpbi5wYW5keW1pYy1pbWFnZWluLXN1Y2Nlc3MgeyAgcG9pbnRlci1ldmVudHM6IG5vbmU7ICBjb2xvcjogIzBjM30ucGFuZHltaWMtaW1hZ2Vpbjpub3QoW2RhdGEtcGFuZHltaWMtaW1hZ2Vpbi1tZXNzYWdlPSIiXSk6YWZ0ZXIgeyAgY29udGVudDogYXR0ciggZGF0YS1wYW5keW1pYy1pbWFnZWluLW1lc3NhZ2UgKSAhaW1wb3J0YW50fQ=='; document.body.appendChild(b) })(document)
</pre>

#### Direct code injection method.
<pre>
javascript:(function(){ window.pandymicImagein = window.pandymicImagein || { config: { css: false, init: false, searchParams: {"baseUrl":"<i>[project-base-url]</i>","css":"LnBhbmR5bWljLWltYWdlaW4geyAgcG9zaXRpb246IHJlbGF0aXZlOyAgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsgIGNvbG9yOiAjNjY2OyAgd2lkdGg6IDUxMnB4OyAgaGVpZ2h0OiA1MTJweDsgIGJvcmRlci1yYWRpdXM6NjBweDsgIHRyYW5zaXRpb246IG9wYWNpdHkgMzc1bXMgZWFzZS1vdXQsIHNjYWxlIDI1MG1zIGVhc2Utb3V0IDEyNW1zO30ucGFuZHltaWMtaW1hZ2Vpbjo6YmFja2Ryb3AgeyAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsgIG9wYWNpdHk6IDAuODU7fS5wYW5keW1pYy1pbWFnZWluOmJlZm9yZSB7ICBjb250ZW50OiAnJzsgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgIHRvcDogMTBweDsgIHJpZ2h0OiAxMHB4OyAgYm90dG9tOiAxMHB4OyAgbGVmdDogMTBweDsgIGJvcmRlcjogNXB4IGRhc2hlZCBjdXJyZW50Y29sb3I7ICBib3JkZXItcmFkaXVzOiA1MHB4fS5wYW5keW1pYy1pbWFnZWluOmFmdGVyIHsgIGNvbnRlbnQ6ICdEcmFnIGZpbGUgaGVyZS4nOyAgcG9zaXRpb246IGFic29sdXRlOyAgdG9wOiA1MCU7ICBsZWZ0OiA1MCU7ICBtYXgtd2lkdGg6IDc1dnc7ICB0cmFuc2xhdGU6IC01MCUgLTUwJTsgIGNvbG9yOiBjdXJyZW50Y29sb3I7ICBmb250LWZhbWlseTogbW9ub3NwYWNlOyAgZm9udC1zaXplOiA1dmg7ICBsaW5lLWhlaWdodDogMS4yOyAgdGV4dC1hbGlnbjogY2VudGVyfS5wYW5keW1pYy1pbWFnZWluLnBhbmR5bWljLWltYWdlaW4tZHJhZzphZnRlciB7ICBjb250ZW50OiAnRHJvcCBmaWxlISd9LnBhbmR5bWljLWltYWdlaW4ucGFuZHltaWMtaW1hZ2Vpbi1lcnJvciB7ICBjb2xvcjogI2MzMH0ucGFuZHltaWMtaW1hZ2Vpbi5wYW5keW1pYy1pbWFnZWluLWRyYWcgeyAgY29sb3I6ICMwNmN9LnBhbmR5bWljLWltYWdlaW4ucGFuZHltaWMtaW1hZ2Vpbi1zdWNjZXNzIHsgIHBvaW50ZXItZXZlbnRzOiBub25lOyAgY29sb3I6ICMwYzN9LnBhbmR5bWljLWltYWdlaW46bm90KFtkYXRhLXBhbmR5bWljLWltYWdlaW4tbWVzc2FnZT0iIl0pOmFmdGVyIHsgIGNvbnRlbnQ6IGF0dHIoIGRhdGEtcGFuZHltaWMtaW1hZ2Vpbi1tZXNzYWdlICkgIWltcG9ydGFudH0="} }, run: () =&gt; { if ( true !== p.config.css ) { p.config.css = true; const style = document.createElement( 'STYLE' ); style.textContent = atob( p.config.searchParams.css ); document.body.appendChild( style ); } if ( true !== p.config.init ) { p.config.cursor = { activeElement: document.activeElement, selection: window.getSelection() }; if ( 'Range' === p.config.cursor.selection.type || 'Caret' === p.config.cursor.selection.type ) { p.config.cursor.range = p.config.cursor.selection.getRangeAt(0); p.init(); } else { delete p.config.cursor; p.config.cursor = {}; } } }, dropTarget: null, createDropTarget: () =&gt; { const dialog = document.createElement( 'DIALOG' ); dialog.dataset.pandymicImageinMessage = ''; dialog.addEventListener( 'close', ( e ) =&gt; { p.config.init = false; delete p.config.cursor; p.config.cursor = null; p.dropTarget.remove(); delete p.dropTarget; p.dropTarget = null; } ); document.body.appendChild( dialog ); dialog.showModal(); return dialog; }, dropHandler: ( e ) =&gt; { e.preventDefault(); p.dropTarget.classList.remove( 'pandymic-imagein-drag' ); const files = Array.from( e.dataTransfer.files ); if ( 0 == files.length ) { dropError( 'File error!' ); } else if ( 1 !== files.length ) { dropError( 'Multiple files not supported!' ); } else { p.fileHandler( files[0] ); } }, pasteHandler: async ( e ) =&gt; { e.preventDefault(); const file = await ( async ( dataTransfer ) =&gt; { for ( let i = 0; i &lt; dataTransfer.items.length; i++ ) { const item = dataTransfer.items[i]; if ( 'file' === item.kind &amp;&amp; 0 === item.type.indexOf( 'image/' ) ) { return item.getAsFile(); } } return false; } )( e.clipboardData ); if ( false === file ) { dropError( 'Pasted content is invalid!' ); } else { p.fileHandler( file ); } }, fileHandler: ( file ) =&gt; { if ( 0 !== file.type.indexOf( 'image/' ) ) { p.dropError( 'Invalid file type!' ); } else { const reader = new FileReader(); reader.addEventListener( 'load', ( e ) =&gt; { const image = new Image(); image.addEventListener( 'load', ( e ) =&gt; { Promise.resolve( createImageBitmap( image ) ).then( ( bitmap ) =&gt; { const maxSize = 960; const canvas = document.createElement( 'CANVAS' ); const context = canvas.getContext( "2d", { alpha: true } ); const { width, height } = bitmap; canvas.width = width; canvas.height = height; const ratio = height / width; if ( height &gt; maxSize &amp;&amp; ratio &gt;= 1 ) { canvas.width = maxSize / ratio; canvas.height = maxSize; } else if ( width &gt; maxSize &amp;&amp; ratio &lt;= 1 ) { canvas.width = maxSize; canvas.height = maxSize * ratio; } context.drawImage( bitmap, 0, 0, width, height, 0, 0, canvas.width, canvas.height ); const dataurl = canvas.toDataURL( 'image/webp' ); canvas.toBlob( ( blob ) =&gt; { if ( null !== blob ) { const formData = new FormData(); formData.append( 'file', blob ); formData.append( 'base64', dataurl ); formData.append( 'name', file.name ); fetch( p.config.searchParams.baseUrl + 'upload.php', { method: 'POST', type: 'multipart/form-data', body: formData } ) .then( function( response ) { return response.json(); } ) .then( function( result ) { p.dropTarget.removeEventListener( 'drop', p.dropHandler ); p.dropTarget.removeEventListener( 'paste', p.pasteHandler ); p.dropTarget.classList.add( 'pandymic-imagein-success' ); p.dropTarget.dataset.pandymicImageinMessage = 'Upload successful!'; if ( 'INPUT' === p.config.cursor.activeElement.nodeName || 'TEXTAREA' === p.config.cursor.activeElement.nodeName ) { var field = p.config.cursor.activeElement; field.value = field.value.substring( 0, field.selectionStart ) + p.config.searchParams.baseUrl + result.path + field.value.substring( field.selectionEnd, field.value.length ); } else { p.config.cursor.range.deleteContents(); var link; if ( 'true' === p.config.cursor.activeElement.contentEditable ) { link = document.createElement( 'A' ); link.href = p.config.searchParams.baseUrl + result.path; link.textContent = p.config.searchParams.baseUrl + result.path; } else { link = document.createTextNode( p.config.searchParams.baseUrl + result.path ); } p.config.cursor.range.insertNode( link ); } setTimeout( () =&gt; { p.dropTarget.style.opacity = 0; p.dropTarget.style.scale = 0.5; setTimeout( () =&gt; { p.config.init = false; delete p.config.cursor; p.config.cursor = null; p.dropTarget.remove(); delete p.dropTarget; p.dropTarget = null; }, 500 ); }, 1000 ); } ); } }, 'image/webp' ); } ); } ); image.src = reader.result; } ); reader.addEventListener( 'error', ( e ) =&gt; { p.dropError( 'Error reading file!' ); } ); reader.readAsDataURL( file ); } }, dropError: ( message ) =&gt; { p.dropTarget.classList.add( 'pandymic-imagein-error' ); p.dropTarget.dataset.pandymicImageinMessage = message; }, init: () =&gt; { p.config.init = true; p.dropTarget = p.createDropTarget(); p.dropTarget.classList.add( 'pandymic-imagein' ); p.dropTarget.addEventListener( 'dragenter', ( e ) =&gt; { e.preventDefault(); if ( p.dropTarget.dataset.pandymicImageinMessage.length ) p.dropTarget.dataset.pandymicImageinMessage = ''; p.dropTarget.classList.remove( 'pandymic-imagein-error' ); p.dropTarget.classList.add( 'pandymic-imagein-drag' ); }); p.dropTarget.addEventListener( 'dragover', ( e ) =&gt; { e.preventDefault(); if ( p.dropTarget.dataset.pandymicImageinMessage.length ) p.dropTarget.dataset.pandymicImageinMessage = ''; p.dropTarget.classList.remove( 'pandymic-imagein-error' ); p.dropTarget.classList.add( 'pandymic-imagein-drag' ); }); p.dropTarget.addEventListener( 'dragleave', ( e ) =&gt; { e.preventDefault(); p.dropTarget.classList.remove( 'pandymic-imagein-drag' ); }); p.dropTarget.addEventListener( 'drop', p.dropHandler ); p.dropTarget.addEventListener( 'paste', p.pasteHandler ); }, reset: () =&gt; { } }; let p = window.pandymicImagein; if ( 'complete' !== document.readyState ) { document.addEventListener( 'DOMContentLoaded', ( e ) =&gt; { p.run(); } ); } else { p.run(); }})();
</pre>

## File Replacer

This is a simple bookmarklet that finds the matching file absolute URL and replaces it with an `<img>` tag that loads the source image directly on the page. Currently only supports anchor tags whose textContent matches the URL pattern exactly.

### Assumptions & Notes

* For privacy the github repo does not include any URL's or paths to the actual production environment. Instead, all of these values are stored server-side in a configuration file called `imagein.conf`. It's assumed that the file is a valid PHP script with a return statement on its last line. It lives in the folder `/etc` relative to the project directory (i.e. `../../etc` relative to the web root.)
* The base URL as well as its regular expression escaped variant in the bookmarklet below are generated server-side for conveninence. See `test.php` in the web root.

### Bookmarklet
<pre>
javascript:(function(a){for(var i = 0; i &lt; a.length; i++) {if ( a[i].textContent.match(/^<i>[project-base-url-preg-escaped]</i>\/file\/[a-fA-F0-9]+\.webp$/) &amp;&amp; 1 === a[i].childNodes.length &amp;&amp; 3 === a[i].childNodes[0].nodeType ) {a[i].dataset.originalText = a[i].textContent;a[i].innerHTML = '&lt;img src="' + encodeURI( a[i].textContent ) + '" style="width:100%;height:auto;max-width:100%"&gt;';}}})(document.getElementsByTagName('*'));
</pre>
